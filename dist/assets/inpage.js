function x(e,r,n){window.postMessage({__gx:!0,direction:"inpage->cs",id:e,result:r,error:n},"*")}async function I(e){if(!e||typeof e.availability!="function")return console.warn("[Typerra][INPAGE] API class missing or has no availability"),"unavailable";try{const r=await e.availability();return console.log("[Typerra][INPAGE] availability:",r),r}catch(r){return console.error("[Typerra][INPAGE] availability check failed",r),"unavailable"}}let g=null,f=null,p=null,l=null,u=null,d=null;function y(e){try{if(!e)return;if(typeof e.dispose=="function"){e.dispose();return}if(typeof e.close=="function"){e.close();return}if(typeof e.destroy=="function"){e.destroy();return}if(typeof e.abort=="function"){e.abort();return}}catch{}}function h(){try{y(g)}catch{}try{y(f)}catch{}try{y(p)}catch{}g=null,f=null,p=null,l=null,u=null,d=null}function _(){try{y(g)}catch{}try{y(f)}catch{}g=null,f=null}function L(e,r){const n=Array.isArray(r?.corrections)?r.corrections:[];let o=String(r?.corrected||r?.text||""),i=[];try{i=n.map(t=>{const a=typeof t.start=="number"?t.start:typeof t.offset=="number"?t.offset:typeof t.startIndex=="number"?t.startIndex:typeof t.range?.start=="number"?t.range.start:typeof t.rangeStart=="number"?t.rangeStart:void 0,s=typeof t.end=="number"?t.end:typeof t.endIndex=="number"?t.endIndex:typeof t.length=="number"&&typeof a=="number"?a+t.length:typeof t.range?.end=="number"?t.range.end:typeof t.rangeEnd=="number"?t.rangeEnd:void 0,c=typeof t.correction=="string"?t.correction:typeof t.replacement=="string"?t.replacement:typeof t.replacementText=="string"?t.replacementText:typeof t.suggestion=="string"?t.suggestion:Array.isArray(t.suggestions)&&t.suggestions.length&&typeof t.suggestions[0]?.replacement=="string"?t.suggestions[0].replacement:Array.isArray(t.suggestions)&&t.suggestions.length&&typeof t.suggestions[0]?.text=="string"?t.suggestions[0].text:void 0;return typeof a=="number"&&typeof s=="number"?{start:a,end:s,replacement:c}:null}).filter(Boolean)}catch(t){console.warn("[Typerra][INPAGE] Failed to normalize ranges",t),i=[]}if(!o&&i.length>0)try{const t=[...i].sort((s,c)=>c.start-s.start);let a=e;for(const s of t){const c=Math.max(0,Math.min(a.length,s.start)),b=Math.max(c,Math.min(a.length,s.end));a=a.slice(0,c)+(typeof s.replacement=="string"?s.replacement:a.slice(c,b))+a.slice(b)}o=a}catch(t){console.warn("[Typerra][INPAGE] Failed to derive corrected text from corrections",t)}return o||(o=e),{corrected:o,corrections:n,ranges:i}}async function P(e={}){return g||l||(l=(async()=>{if(await I(window.Writer)==="unavailable")throw new Error("Writer API unavailable in this browser.");const n=await window.Writer.create({...e,monitor(o){o.addEventListener("downloadprogress",i=>{})},expectedInputLanguages:["en"],expectedContextLanguages:["en"],outputLanguage:"en"});return g=n,l=null,n})().catch(r=>{throw l=null,r}),l)}async function E(e={}){return f||u||(u=(async()=>{if(await I(window.Rewriter)==="unavailable")throw new Error("Rewriter API unavailable in this browser.");const n=await window.Rewriter.create({...e,monitor(o){o.addEventListener("downloadprogress",i=>{})},expectedInputLanguages:["en"],expectedContextLanguages:["en"],outputLanguage:"en"});return f=n,u=null,n})().catch(r=>{throw u=null,r}),u)}async function A(e={}){return p||d||(d=(async()=>{if(await I(window.Proofreader)==="unavailable")throw new Error("Proofreader API unavailable in this browser.");const n=await window.Proofreader.create({...e,monitor(o){o.addEventListener("downloadprogress",i=>{try{const{loaded:t,total:a}=i||{};console.log("[Typerra][INPAGE] Proofreader download progress",t,"/",a)}catch{}})},expectedInputLanguages:["en"]});return p=n,d=null,n})().catch(r=>{throw d=null,r}),d)}function S(e){if(e&&(e==="neutral"||e==="casual"||e==="formal"))return e}function D(e){if(e&&(e==="short"||e==="medium"||e==="long"))return e}function T(e){if(e&&(e==="more-casual"||e==="as-is"||e==="more-formal"))return e}function N(e){if(e&&(e==="shorter"||e==="as-is"||e==="longer"))return e}let w=Date.now(),m=Date.now();async function M(e,r){switch(e){case"ping":return m=Date.now(),{ok:!0,t:m};case"warmup":return w=Date.now(),await G(),{ok:!0};case"ensure":{w=Date.now();const n=String(r?.model||"").toLowerCase();if(n==="proofreader")return await A(),{ok:!0,model:"proofreader"};if(n==="writer")return await P(),{ok:!0,model:"writer"};if(n==="rewriter")return await E(),{ok:!0,model:"rewriter"};throw new Error("Unknown model: "+n)}case"dispose":return h(),{ok:!0};case"disposeNonProofreader":return _(),{ok:!0};case"write":{w=Date.now();const{prompt:n,tone:o,length:i}=r||{},a=await(await P({tone:S(o),length:D(i)})).write(String(n||""));return String(a)}case"rewrite":{w=Date.now();const{text:n,tone:o,length:i,context:t}=r||{},a=await E({tone:T(o),length:N(i)}),s=String(t||"Only rewrite the provided text according to the requested tone/length. Preserve the original meaning and information. Do not add new ideas, remove content, or include explanations. Return only the rewritten text."),c=await a.rewrite(String(n||""),{context:s});return String(c).trim()}case"proofread":{w=Date.now();const{text:n}=r||{},o=await A(),i=String(n||"");try{const t=await o.proofread(i);return L(i,t)}catch(t){const a=(t?.message||t||"").toString().toLowerCase();if((t?.name||"").toString().toLowerCase()==="aborterror"||a.includes("cancel"))return{corrected:i,corrections:[],ranges:[],cancelled:!0};throw t}}default:throw new Error(`Unknown method: ${e}`)}}window.addEventListener("message",async e=>{const r=e.data;if(!r||r.__gx!==!0||r.direction!=="cs->inpage")return;const{id:n,method:o,params:i}=r;try{const t=await M(o,i);x(n,t)}catch(t){x(n,void 0,t?.message||String(t))}});let v=!1;async function G(){if(!(v||window.__GX_WARMUP_STARTED__)){v=!0,window.__GX_WARMUP_STARTED__=!0;try{await Promise.all([A().catch(e=>console.warn("[Typerra][INPAGE] Proofreader warmup skipped",e?.message||e)),E().catch(e=>console.warn("[Typerra][INPAGE] Rewriter warmup skipped",e?.message||e)),P().catch(e=>console.warn("[Typerra][INPAGE] Writer warmup skipped",e?.message||e))]),console.log("[Typerra][INPAGE] Warmup done")}catch(e){console.warn("[Typerra][INPAGE] Warmup error",e)}finally{v=!1}}}try{window.addEventListener("beforeunload",()=>{try{h()}catch{}},{once:!0}),window.addEventListener("pagehide",()=>{try{h()}catch{}},{once:!0})}catch{}const k=3e4,R=3e4,W=2e4,C=15e3;try{setInterval(()=>{const e=Date.now(),r=e-w,n=e-m,o=document.visibilityState==="hidden"?W:k;if(r>o||n>R){try{h()}catch{}w=e,m=e}},C)}catch{}
